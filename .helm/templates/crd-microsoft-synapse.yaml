{{- if .Values.customResourceDefinitions.create }}
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: microsoft-synapse-streams.streaming.sneaksanddata.com
spec:
  group: streaming.sneaksanddata.com
  scope: Namespaced
  names:
    plural: microsoft-synapse-streams
    singular: microsoft-synapse-stream
    kind: MicrosoftSynapseStream
    shortNames:
      - mssynapsestream
  versions:
    - name: v1
      served: true
      storage: true
      additionalPrinterColumns:
        - name: Source location
          type: string
          jsonPath: .spec.sourceSettings.baseLocation
        - name: Entity
          type: string
          jsonPath: .spec.sourceSettings.name
        - name: Change Capture Interval
          type: string
          jsonPath: .spec.sourceSettings.changeCaptureIntervalSeconds
        - name: Sink location
          type: string
          jsonPath: .spec.sinkSettings.targetTableName
        - name: Phase
          type: string
          jsonPath: .status.phase
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                tableProperties:
                  type: object
                  default:
                    partitionExpressions: []
                    sortedBy: []
                    parquetBloomFilterColumns: []
                    format: PARQUET
                  properties:
                    partitionExpressions:
                      type: array
                      items:
                        type: string
                      default: []
                    sortedBy:
                      type: array
                      items:
                        type: string
                      default: [ ]
                    parquetBloomFilterColumns:
                      type: array
                      items:
                        type: string
                      default: [ ]
                    format:
                      type: string
                      enum:
                        - PARQUET
                        - ORC
                        - AVRO
                      default: PARQUET
                sourceSettings:
                  type: object
                  properties:
                    name:
                      type: string
                    baseLocation:
                      type: string
                      description: Location root for Synapse Link data (Dataverse container), in a format abfss://account@container.dfs.core.windows.net/
                    changeCaptureIntervalSeconds:
                      type: integer
                      description: How long to wait before polling for next change set. Accepted range is between 1s and 3600s
                      minimum: 1
                      maximum: 3600
                connectionStringRef:
                  description: |
                    Name of the secret containing connection details to Synapse storage account and Trino.
                  type: object
                  properties:
                    name:
                      type: string
                jobTemplateRef:
                  description: |
                    Name of the job template to be used for the application in streaming mode.
                  type: object
                  properties:
                    name:
                      type: string
                    kind:
                      type: string
                    apiGroup:
                      type: string
                backfillJobTemplateRef:
                  description: |
                    Name of the job template to be used for the for the application in backfill mode.
                  type: object
                  properties:
                    name:
                      type: string
                    kind:
                      type: string
                    apiGroup:
                      type: string
                httpClientMaxRetries:
                  type: integer
                  description: Max number of retries on blob reads for the http client.
                httpClientRetryDelaySeconds:
                  type: integer
                  description: Max retry delay on blob reads for the http client.
                rowsPerGroup:
                  type: integer
                  description: Maximum number of rows to be grouped together for the staging process to consume.
                groupingIntervalSeconds:
                  type: integer
                  description: Max time to wait for rowsPerGroup to accumulate and then proceed to staging. Can be from 1 to 60 seconds.
                  minimum: 1
                  maximum: 60
                sinkSettings:
                  type: object
                  properties:
                    optimizeSettings:
                      type: object
                      description: Configuration for target table optimize (data file aggregation into bigger files)
                      properties:
                        batchThreshold:
                          type: integer
                          default: 60
                          description: Number of batches to accumulate before triggering the OPTIMIZE
                        fileSizeThreshold:
                          type: string
                          default: 100MB
                          description: File size to target when running OPTIMIZE
                      default:
                        batchThreshold: 60
                        fileSizeThreshold: 100MB
                    snapshotExpirationSettings:
                      type: object
                      description: Configuration for EXPIRE SNAPSHOTS (table transaction log cutoff)
                      properties:
                        batchThreshold:
                          type: integer
                          default: 60
                          description: Number of batches to accumulate triggering EXPIRE SNAPSHOTS
                        retentionThreshold:
                          type: string
                          default: 6h
                          description: Maximum age of records in the transaction log to keep
                      default:
                        batchThreshold: 60
                        retentionThreshold: 6h
                    orphanFilesExpirationSettings:
                      type: object
                      description: Orphan files cleanup settings.
                      properties:
                        batchThreshold:
                          type: integer
                          default: 60
                          description: Configuration for EXPIRE ORPHAN FILES (cleanup of files no longer referenced by Iceberg snapshots)
                        retentionThreshold:
                          type: string
                          default: 6h
                          description: Number of batches to accumulate before triggering EXPIRE ORPHAN FILES
                      default:
                        batchThreshold: 60
                        retentionThreshold: 6h
                    analyzeSettings:
                      type: object
                      description: Configuration for ANALYZE (full refresh of extended statistics on the target)
                      properties:
                        batchThreshold:
                          type: integer
                          default: 60
                          description: Number of batches to accumulate before running the ANALYZE query.
                        includedColumns:
                          type: array
                          description: Columns to include in the ANALYZE query. If empty, ALL columns will be included.
                          items:
                            type: string
                          default: []
                      default:
                        batchThreshold: 60
                        includedColumns: []
                    targetTableName:
                      type: string
                      description: Name for the target Iceberg table.
                    sinkCatalogSettings:
                      type: object
                      description: Connection settings for Iceberg REST Catalog for the sink (target). This is used by watermarking process.
                      properties:
                        namespace:
                          type: string
                        warehouse:
                          type: string
                        catalogUri:
                          type: string
                lookBackInterval:
                  type: integer
                  description: |
                    DEPRECATED - TO BE REMOVED IN 2.1 RELEASE. DO NOT USE THIS SETTING!
                    
                    Number of seconds to look back when determining first set of changes to extract.
                    Can be set in interval from 1 second to 10 hours. Default is 1 hour.
                  minimum: 1
                  maximum: 1209600
                  default: 3600
                stagingDataSettings:
                  type: object
                  properties:
                    dataLocation:
                      type: string
                      description: Option data location override. Only use this setting for debugging and never in production environments.
                    maxRowsPerFile:
                      type: integer
                      description: The maximum number of rows per each data file in the staging table.
                      default: 10000
                    tableNamePrefix:
                      type: string
                      description: Prefix for staging tables created by Arcane. Must be UNIQUE in the WAREHOUSE scope.
                    catalog:
                      type: object
                      description: Settings for Iceberg REST Catalog used for staging tables
                      properties:
                        catalogName:
                          type: string
                        schemaName:
                          type: string
                        warehouse:
                          type: string
                        catalogUri:
                          type: string
                backfillBehavior:
                  type: string
                  enum:
                    - merge
                    - overwrite
                  default:
                    overwrite
                fieldSelectionRule:
                  type: object
                  description: INCLUDE will only use fields provided. You must specify mandatory fields like ARCANE_MERGE_KEY as well. EXCLUDE will exclude provided fields instead. ALL (default) will use all fields without filters.
                  properties:
                    ruleType:
                      type: string
                      enum:
                        - include
                        - exclude
                        - all
                    fields:
                      type: array
                      items:
                        type: string
                  default:
                    ruleType: all
                    fields: []
                backfillStartDate:
                  description: |
                    The date and time to start backfilling data from.
                    The date should be in the following format: "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"
                  type: string
                suspended:
                  description: Suspended indicates whether the stream is suspended.
                  type: boolean
            status:
              type: object
              properties:
                phase:
                  type: string
                configurationHash:
                  description: ConfigurationHash represents the hash of the current
                    configuration.
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - status
                      - type
                    properties:
                      message:
                        type: string
                      type:
                        type: string
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
  {{- end }}
